var qLen,qTemp,pK,module,currentIdbName,idbObj={};function processed(){var e=arguments[0];e&&e.ScriptError&&self.postMessage({ScriptErr:{msg:e.msg,ScriptError:!0}}),++qTemp==qLen&&getAll({model:module}).then(function(e){var r=[],t=e.data||[],a=pK.split(",");t.forEach(function(e){var t;a.length>1?(t={},a.forEach(function(r,a){t[r]=e[r]})):t=e[pK],r.push(t)}),self.postMessage({lyteidb:!0,qProcess:"completed4",data:r})},function(e){e.ScriptError&&self.postMessage({ScriptErr:{msg:e.msg,ScriptError:!0}})})}function qProcess(e,r){switch(1==e.queryCache&&"getCachedData"===e.type&&(!e.queryParams||e.queryParams&&0==Object.keys(e.queryParams).length)&&("findAll"==e.req?e.type="getAll":"findRecord"==e.req&&(e.type="get")),e.type){case"getCachedData":getCachedData(e).then(function(r){self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:200,data:r,req:e.req,key:e.key})},function(r){var t={lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req,key:e.key};r&&r.ScriptError&&(t.ScriptErr=r),self.postMessage(t)});break;case"pushPayload":if(!e.data[e.model]){var t=e.data;e.data={},e.data[e.model]=t}case"findAll":case"findRecord":case"push":push(e,e.type).then(processed,processed);break;case"open":openIDB(e);break;case"create":addMultiple(e).then(processed,processed);break;case"createRecord":addData(e).then(processed,processed);break;case"delete":deleteMultiple(e).then(processed,processed);break;case"destroyRecord":case"deleteRecord":deleteData(e).then(processed,processed);break;case"update":updateMultiple(e).then(processed,processed);break;case"updateRecord":updateData(e).then(processed,processed);break;case"get":e.processKey=!0,getData(e).then(function(r){getCachedMeta(e).then(function(t){if(void 0==r.data)self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req,key:e.key});else{var a={};a[e.model]=r.data,t&&(a.meta=t),self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:200,data:a,req:e.req,key:e.key})}},function(t){var a={lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req,key:e.key};if(t&&t.ScriptError&&(a.ScriptErr=ScriptError,self.postMessage(a)),void 0==r.data)self.postMessage(a);else{var n={};n[e.model]=r.data,self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:200,data:n,req:e.req,key:e.key})}})},function(r){var t={lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req,key:e.key};r&&r.ScriptError&&(t.ScriptErr=ScriptError),self.postMessage(t)});break;case"getAll":getAll(e).then(function(r){getCachedMeta(e).then(function(t){if(Array.isArray(r.data)&&!r.data.length)self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req});else{var a={};a[e.model]=r.data,t&&(a.meta=t),self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:200,data:a,req:e.req})}},function(t){var a={lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req};if(t&&t.ScriptError&&(a.ScriptErr=t,self.postMessage(a)),Array.isArray(r.data)&&!r.data.length)self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req});else{var n={};n[e.model]=r.data,self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:200,data:n,req:e.req})}})},function(r){var t={lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req};r&&r.ScriptError&&(t.ScriptErr=r),self.postMessage(t)});break;case"close":idbObj[currentIdbName].close();break;default:self.postMessage({lyteidb:!0,msg:"No such actions defined "+e.type,data:e.data})}}function getCachedMeta(e){return new Promise(function(r,t){var a=e.model,n=(e.queryParams,e.req),o=e.key;getData({model:"__meta",key:a}).then(function(a){try{if(void 0==a.data)return t();var c,d=a.data.cache,s=checkWithQp(d=d[n],e,o);if(-1!=s){var i=d[s];if("findRecord"==n){if(!i.key||!o||i.key!=o)return t();c=i.meta}else c=i.data.meta;return r(c)}return t()}catch(e){return t({msg:e,ScriptError:!0})}},function(e){return t(e)})})}function getCachedData(e){return new Promise(function(r,t){try{var a=e.model,n=(e.queryParams,e.req),o=e.key;getData({model:"__meta",key:a}).then(function(c){try{if(void 0==c.data)return t();var d=c.data.cache,s=checkWithQp(d=d[n],e);if(-1==s)return t();var i,u=d[s];if("findRecord"==n){if(!u.key||!o||u.key!=o)return t();i=[u.data]}else i=u.data[a];if(!i||!i.length){var l={};return"findRecord"==n?(l[e.model]={},void 0!==u.meta&&(l.meta=u.meta)):"findAll"==n&&(l[e.model]=[],u.data&&u.data.meta&&(l.meta=u.data.meta)),r(l)}var m=i.length,f=0,y=[];i.forEach(function(o,c){getData({model:a,key:o,processKey:!0}).then(function(a){try{if(y[c]=a.data,++f==m){var o={};return"findRecord"==n?(o[e.model]=y[0],void 0!==u.meta&&(o.meta=u.meta)):(o[e.model]=y,u.data&&u.data.meta&&(o.meta=u.data.meta)),r(o)}}catch(e){return t({msg:e,ScriptError:!0})}},function(e){return t(e)})})}catch(e){return t({msg:e,ScriptError:!0})}},function(e){return t(e)})}catch(e){return t({msg:e,ScriptError:!0})}})}function checkAndRemoveCachedData(e,r){return new Promise(function(r,t){var a=e.model,n=(e.queryParams,e.key);getData({model:"__meta",key:a}).then(function(e){try{if(void 0==e.data)return t();var o,c=e.data.cache,d=!1;for(var s in c)for(var i=s,u=(o=c[s]).length-1;u>=0;u--){var l,m=o[u];if("findRecord"==i){if(!m.key||!n||m.key!=n)return t();o.splice(u,1),d=!0}else if("findAll"==i){l=m.data[a],valsLen=l.length,keyLen=Object.keys(n).length;for(var f=0;f<valsLen;f++){var y=0;for(var p in n)n[p]&&l[f][p]===n[p]&&y++;if(y===keyLen){o.splice(u,1),d=!0;break}}}}if(!d)return r();updateData({model:"__meta",data:e.data,key:a}).then(function(){return r()},function(e){return self.console.error("error adding ",e.data),t(e)})}catch(e){return t({msg:e,ScriptError:!0})}},function(e){return t(e)})})}function postMsg(e){self.postMessage(e)}function getPk(e,r){var t,a=e.split(",");return a.length>1?(t={},a.forEach(function(e){t[e]=r[e]})):1==a.length&&((t={})[a[0]]=r[a[0]]),t}function push(e,r){return new Promise(function(t,a){try{e.data.length;var n=e.model;console.log(e.data),checkAndInsert(n,e.data).then(function(o){try{if("pushPayload"==r)return t();getData({model:"__meta",key:n}).then(function(o){try{var c={};c.queryParams=e.queryParams;var d=c.data=e.data;if("findRecord"==r)c.key=e.key,c.data=getPk(pK,c.data[n]),e.meta&&(c.meta=e.meta);else for(var s=d[n].length,i=0;i<s;i++)d[n][i]=getPk(pK,d[n][i]);if(void 0==o.data){var u={};u.module=n,u.cache={},u.cache[r]=u.data||[],checkQpAndPush(u.cache[r],c,c.key),addData({model:"__meta",data:u}).then(function(){return t()},function(e){return self.console.error("error adding ",u),a(e)})}else o.data.cache[r]=o.data.cache[r]||[],checkQpAndPush(o.data.cache[r],c,c.key),updateData({model:"__meta",data:o.data,key:n}).then(function(){return t()},function(e){return self.console.error("error adding ",o.data),a(e)})}catch(e){return a({msg:e,ScriptError:!0})}},function(e){t(e)})}catch(e){return a({msg:e,ScriptError:!0})}},function(e){a(e)})}catch(e){return a({msg:e,ScriptError:!0})}})}function checkQpAndPush(e,r){r&&!Array.isArray(r)&&(r=[r]),r.forEach(function(r,t){var a=checkWithQp(e,r);-1==a?e.push(r):e[a]=r})}function checkWithQp(e,r,t){for(var a=-1,n=(e=e||[]).length,o=r.queryParams||{},c=0;c<n;c++)if(void 0===t||"findRecord"==r.req&&void 0!==t&&e[c].key==t){var d;if((d=e[c].queryParams||{})==o){a=c;break}var s=Object.keys(d).length;if(s!=Object.keys(o).length)continue;var i=0;for(var u in d)d[u]==o[u]&&i++;if(i==s){a=c;break}}return a}function checkAndInsert(e,r){var t=!1;return new Promise(function(a,n){try{r=(r=r[e])||[],Array.isArray(r)||(r=[r]);var o=r.length,c=0;r.length?open(idbObj[currentIdbName].name,idbObj[currentIdbName].version).then(function(){try{var d,s=idbObj[currentIdbName].transaction([e],"readwrite").objectStore(e);s.indexNames.contains("pk")&&(s=s.index("pk")),r.forEach(function(i,u){if("string"==typeof s.keyPath)d=i[s.keyPath];else if(Array.isArray(s.keyPath)){var l=[];s.keyPath.forEach(function(e){l.push(i[e])}),d=l}getData({model:e,key:d}).then(function(d){try{void 0==d.data?addData({model:e,data:i}).then(function(){try{if(++c==o)return t?n():a(r)}catch(e){return n({msg:e,ScriptError:!0})}},function(){try{if(t=!0,++c==o)return t?n():a(r)}catch(e){return n({msg:e,ScriptError:!0})}}):updateData({model:e,data:i}).then(function(){try{if(++c==o)return t?n():a(r)}catch(e){return n({msg:e,ScriptError:!0})}},function(){try{if(t=!0,++c==o)return t?n():a(r)}catch(e){return n({msg:e,ScriptError:!0})}})}catch(e){return n({msg:e,ScriptError:!0})}},function(e){return n(e)})})}catch(e){return n({msg:e,ScriptError:!0})}},function(e){return n(e)}):a()}catch(e){return n({msg:e,ScriptError:!0})}})}function openIDB(e){open(e.name||"lyte",e.version,e.models,e.maintainOrder).then(function(){idbObj[currentIdbName].close(),self.postMessage({lyteidb:!0,msg:"successfully upgraded db",type:"open"})},function(){self.postMessage({lyteidb:!0,msg:"error"})})}function open(e,r,t,a){return new Promise(function(n,o){try{var c=indexedDB.open(e,r);c.onupgradeneeded=function(e){try{idbObj[currentIdbName]=e.target.result,t&&t.forEach(function(e,r){idbObj[currentIdbName].objectStoreNames.contains(e.modelName)||(!0===(e.hasOwnProperty("maintainOrder")?e.maintainOrder:a)?idbObj[currentIdbName].createObjectStore(e.modelName,{autoIncrement:!0}).createIndex("pk",e.pK.split(",")):idbObj[currentIdbName].createObjectStore(e.modelName,{keyPath:e.pK.split(",")}))}),idbObj[currentIdbName].objectStoreNames.contains("__meta")||idbObj[currentIdbName].createObjectStore("__meta",{keyPath:"module"}),n({lyteidb:!0,msg:"successfully upgraded db",type:"open"})}catch(e){o({msg:e,ScriptError:!0})}},c.onblocked=function(e){o({lyteidb:!0,msg:"error"})},c.onsuccess=function(e){idbObj[currentIdbName]=e.target.result,idbObj[currentIdbName].addEventListener("versionchange",function(){console.log("version change",arguments)}),n({lyteidb:!0,msg:"successfully opened db",type:"open"})},c.onerror=function(e){o({lyteidb:!0,msg:"error"})}}catch(e){return o({msg:e,ScriptError:!0})}})}function addMultiple(e){return new Promise(function(r,t){try{var a=e.data.length,n=0;e.data.forEach(function(t,o){addData({model:e.model,data:t},!1).then(function(){if(++n==a)return idbObj[currentIdbName].close(),r()},function(){if(++n==a)return idbObj[currentIdbName].close(),r()})})}catch(e){return t({msg:e,ScriptError:!0})}})}function addData(e,r){return new Promise(function(t,a){var n=e.data,o=e.model;open(idbObj[currentIdbName].name,idbObj[currentIdbName].version).then(function(){try{var e=idbObj[currentIdbName].transaction([o],"readwrite").objectStore(o).add(n);e.onsuccess=function(e){return!1!==r&&idbObj[currentIdbName].close(),t({msg:"Successfully added data"})},e.onerror=function(e){return!1!==r&&idbObj[currentIdbName].close(),a({msg:"Error while adding data"})},e.oncomplete=function(e){return!1!==r&&idbObj[currentIdbName].close(),t({msg:"Successfully added data"})}}catch(e){return a({msg:e,ScriptError:!0})}},function(){return a({msg:"Cannot open indexeddb"})})})}function deleteMultiple(e){return new Promise(function(r,t){try{var a=e.data.length,n=0;e.data.forEach(function(t,o){deleteData({model:e.model,key:t},!1).then(function(){if(++n==a)return idbObj[currentIdbName].close(),r()},function(){if(++n==a)return idbObj[currentIdbName].close(),r()})})}catch(e){return t({msg:e,ScriptError:!0})}})}function deleteData(e,r){return new Promise(function(t,a){try{var n=e.model,o=e.key;open(idbObj[currentIdbName].name,idbObj[currentIdbName].version).then(function(){try{var c,d=idbObj[currentIdbName].transaction([n],"readwrite").objectStore(n);if(d.indexNames.contains("pk")){if("string"==typeof(c=d.index("pk")).keyPath)e.key=o=e.key[c.keyPath];else if(Array.isArray(c.keyPath)){var s=[];c.keyPath.forEach(function(r){s.push(e.key[r])}),o=s}openCursorForKey(c,o).then(function(n){try{var o=n.cursor.primaryKey,c=d.delete(o);c.onsuccess=function(a){if(!1!==r&&idbObj[currentIdbName].close(),1!=e.queryCache)return t({msg:"Successfully deleted data"});checkAndRemoveCachedData(e).then(function(){return t({msg:"Successfully deleted data"})},function(){return t({msg:"Successfully deleted data"})})},c.onerror=function(e){return!1!==r&&idbObj[currentIdbName].close(),a({msg:"Error while deleting data"})},c.oncomplete=function(e){return!1!==r&&idbObj[currentIdbName].close(),t({msg:"Successfully deleted data"})}}catch(e){a({msg:e,ScriptError:!0})}})}else{if("string"==typeof d.keyPath)e.key=o=e.key[d.keyPath];else if(Array.isArray(d.keyPath)){s=[];d.keyPath.forEach(function(r){s.push(e.key[r])}),o=s}var i=d.delete(o);i.onsuccess=function(a){if(!1!==r&&idbObj[currentIdbName].close(),1!=e.queryCache)return t({msg:"Successfully deleted data"});checkAndRemoveCachedData(e).then(function(){return t({msg:"Successfully deleted data"})},function(){return t({msg:"Successfully deleted data"})})},i.onerror=function(e){return!1!==r&&idbObj[currentIdbName].close(),a({msg:"Error while deleting data"})},i.oncomplete=function(e){return!1!==r&&idbObj[currentIdbName].close(),t({msg:"Successfully deleted data"})}}}catch(e){return a({msg:e,ScriptError:!0})}},function(){return a({msg:"Cannot open indexeddb"})})}catch(e){return a({msg:e,ScriptError:!0})}})}function updateMultiple(e){return new Promise(function(r,t){try{var a=e.data.length,n=0;e.data.forEach(function(t,o){updateData({model:e.model,data:e.data},!1).then(function(){if(++n==a)return idbObj[currentIdbName].close(),r()},function(){if(++n==a)return idbObj[currentIdbName].close(),r()})})}catch(e){return t({msg:e,ScriptError:!0})}})}function updateData(e,r){return new Promise(function(t,a){var n=e.model,o=e.data;e.key;getData(e).then(function(c){try{var d=c.data;if(void 0==c.data)addData(e).then(function(){return t({msg:"Successfully added data"})},function(){return a({msg:"Error while adding data"})});else{for(var s in o)d[s]=o[s];open(idbObj[currentIdbName].name,idbObj[currentIdbName].version).then(function(){try{var o,c=idbObj[currentIdbName].transaction([n],"readwrite").objectStore(n);if(c.indexNames.contains("pk")){if(!0,"string"==typeof(o=c.index("pk")).keyPath)e.key=s=e.data[o.keyPath];else if(Array.isArray(o.keyPath)){var i=[];o.keyPath.forEach(function(r){i.push(e.data[r])}),s=i}openCursorForKey(o,s).then(function(n){try{var o=n.cursor.primaryKey;void 0!==o&&openCursorForKey(c,o).then(function(n){try{var o=n.cursor.update(e.data);o.onsuccess=function(e){e.target.result;return!1!==r&&idbObj[currentIdbName].close(),t({msg:"Successfully updated data"})},o.onerror=function(e){return!1!==r&&idbObj[currentIdbName].close(),a({msg:"Error while updating data"})},o.oncomplete=function(e){return!1!==r&&idbObj[currentIdbName].close(),t({msg:"Successfully updated data"})}}catch(e){return a({msg:e,ScriptError:!0})}})}catch(e){a({msg:e,ScriptError:!0})}})}else{var u=c.put(d);u.onsuccess=function(e){return!1!==r&&idbObj[currentIdbName].close(),t({msg:"Successfully updated data"})},u.onerror=function(e){return!1!==r&&idbObj[currentIdbName].close(),a({msg:"Error while updating data"})},u.oncomplete=function(e){return!1!==r&&idbObj[currentIdbName].close(),t({msg:"Successfully updated data"})}}}catch(e){return a({msg:e,ScriptError:!0})}},function(){return a({msg:"Cannot open indexeddb"})})}}catch(e){return a({msg:e,ScriptError:!0})}},function(){return a({msg:"Error while updating data"})})})}function getData(e){return new Promise(function(r,t){var a=e.model,n=e.key;if(!idbObj[currentIdbName]||!idbObj[currentIdbName].objectStoreNames.contains(a))return t({msg:"Error while getting data"});open(idbObj[currentIdbName].name,idbObj[currentIdbName].version).then(function(){try{var o=idbObj[currentIdbName].transaction([a],"readwrite").objectStore(a);if(o.indexNames.contains("pk")&&(o=o.index("pk")),e.processKey){if(Array.isArray(o.keyPath)){var c=[];n&&"object"==typeof n?o.keyPath.forEach(function(e){c.push(n[e])}):c.push(n),n=c}}else if(!n&&e.data)if("string"==typeof o.keyPath)n=e.data[o.keyPath];else if(Array.isArray(o.keyPath)){c=[];o.keyPath.forEach(function(r){c.push(e.data[r])}),n=c}var d=o.get(n);d.onsuccess=function(e){return idbObj[currentIdbName].close(),r({msg:"Successfully got data success",data:e.target.result})},d.onerror=function(e){return idbObj[currentIdbName].close(),t({msg:"Error while getting data"})},d.oncomplete=function(e){return idbObj[currentIdbName].close(),r({msg:"Successfully got data complete",data:e.target.result})}}catch(e){return t({msg:e,ScriptError:!0})}},function(){return t({msg:"Cannot open indexeddb"})})})}function getAll(e){return new Promise(function(r,t){var a=e.model;if(!idbObj[currentIdbName]||!idbObj[currentIdbName].objectStoreNames.contains(a))return t({msg:"Error while getting data"});open(idbObj[currentIdbName].name,idbObj[currentIdbName].version).then(function(){try{var e=idbObj[currentIdbName].transaction([a],"readwrite").objectStore(a).getAll();e.onsuccess=function(e){return idbObj[currentIdbName].close(),r({msg:"Successfully got data",data:e.target.result})},e.onerror=function(e){return idbObj[currentIdbName].close(),t({msg:"Error while getting data"})},e.oncomplete=function(e){return idbObj[currentIdbName].close(),r({msg:"Successfully got data",data:e.target.result})}}catch(e){return t({msg:e,ScriptError:!0})}},function(){return t({msg:"Cannot open indexeddb"})})})}function openCursorForKey(e,r){return new Promise(function(t,a){var n=e.openCursor(r);n.onsuccess=function(e){return t({cursor:e.target.result})},n.onerror=function(){return a("Curson not established")}})}self.onmessage=function(e){try{var r=e.data;if(r.tolyteidb)if(currentIdbName=r.name||"lyte","open"==r.type||idbObj.hasOwnProperty(currentIdbName))if("push"==r.type){qLen=qTemp=0,module=r.module,pK=void 0;var t=r.data;Array.isArray(t)||(t=[t]),pK=r.pK,qLen=t.length,t.forEach(function(e,r){qProcess(e,e.type)})}else qProcess(r,r.type);else self.postMessage({lyteidb:!0,pause:!0,model:r.model,type:r.type})}catch(e){self.postMessage({lyteidb:!0,pause:!0,model:r.model,type:r.type,scriptErr:{msg:e,ScriptError:!0}})}},self.postMessage({lyteidb:!0,init:"done"});
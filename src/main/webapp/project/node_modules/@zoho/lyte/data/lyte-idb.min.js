var LyteIDB={isProcessing:!1,restoreData:!1,maintainOrder:!1,idbNamePrefix:"lidb_",idb:{},getBlobURL:function(e){return URL.createObjectURL(new Blob(["importScripts( '"+e+"' );"],{type:"text/javascript"}))},changeIDBState:function(e,t){e.$.inIDB=e.$.inIDB||{},t?(e.$.inIDB[t.model]=e.$.inIDB[t.model]||new Map,e.$.inIDB[t.model].set(t.pK,!0)):Object.defineProperty(e.$.inIDB,"self",{value:!0});var r=store.model[e.$.model._name]&&store.model[e.$.model._name].idb?store.model[e.$.model._name].idb.deserializeKeys:void 0;if(r)for(var a=0;a<r.length;a++){var o=e.$.model.fieldList[r[a]];if(e.hasOwnProperty(r[a])&&"hasMany"==o.relType)if(Array.isArray(e[r[a]])){for(var i=0;i<e[r[a]].length;i++)Lyte.isRecord(e[r[a]][i])&&this.changeIDBState(e[r[a]][i],t||{model:e.$.model._name,pK:e.$.pK});e[r[a]].inIDB=e[r[a]].inIDB||Object.defineProperty(e[r[a]],"inIDB",{value:{}}),t?(e[r[a]].inIDB[t.model]=e[r[a]].inIDB[t.model]||new Map,e[r[a]].inIDB[t.model].set(t.pK,!0)):e[r[a]].inIDB.self=!0}else Lyte.isRecord(e[r[a]])&&this.changeIDBState(e[r[a]],t||{model:e.$.model._name,pK:e.$.pK})}},initWorker:function(e){return new Promise(function(t,r){var a=LyteIDB.worker=new Worker(LyteIDB.getBlobURL(e));a.onmessage=function(e){try{var o=e.data;if(o&&o.lyteidb)if("open"==o.type){if("error"!=o.msg){void 0!=store.adapter.application&&store.adapter.application.differIDBAction||setTimeout(function(){LyteIDB.triggerIDBInsertion()},0),Object.defineProperty(LyteIDB,"isIDBOpened",{value:!0}),Object.defineProperty(store.$,"idbOpen",{value:!1});var i=window.location.host,n=localStorage.getItem("idb"+i);void 0==n?localStorage.setItem("idb"+i,1):(n=parseInt(n),localStorage.setItem("idb"+i,n+1)),!1===LyteIDB.restoreData&&window.addEventListener("beforeunload",function(){LyteIDB.removeCurrentIDB()})}}else if("completed4"==o.qProcess){var d=Object.keys(store.$.idbQ2)[0];(o.data||[]).forEach(function(e,t){var r=store.$.peekRecord(d,e);Lyte.isRecord(r)&&(r.$.inIDB=!0)}),delete store.$.idbQ2[d],LyteIDB.isProcessing=!1}else if(o.hasOwnProperty("code")){var s=o.req,l=LyteIDB[o.model][o.req],c="findRecord"==s?l[o.key].splice(0,1)[0]:l.splice(0,1)[0];o.customData=c.customData,200==o.code?c&&c.resolve&&LyteIDB.normalizeIDBData(o).then(function(e){c.resolve(e)},function(){c.reject()}):(400==o.code||o.ScriptErr)&&(o.ScriptErr&&Lyte.error(o.ScriptErr.msg),c&&c.reject&&c.reject()),0==l.length&&delete LyteIDB[o.model][o.req]}else if(o.pause){c=LyteIDB[o.model][o.req];var m=localStorage.getItem("pause");localStorage.setItem("pause",!m),c&&(c=Array.isArray(c)?c:[c]).forEach(function(e){e&&e.reject&&(o.ScriptErr&&Lyte.error(o.ScriptErr.msg),e.reject())})}else if("done"==o.init)return t(a);if(o.ScriptErr)return Lyte.error(o.ScriptErr),r();0==Object.keys(store.$.idbQ2).length&&(LyteIDB.isProcessing=!1)}catch(e){return Lyte.error(e),r()}},a.onerror=function(e){r()}})},init:function(e){try{var t=!1,r=window.location.host;localStorage.setItem(r+"parent",Date.now()),window.addEventListener("storage",function(e){e.key==r+"child"&&(t=!0),e.key==r+"parent"&&localStorage.setItem(r+"child",Date.now())});var a=this;return new Promise(function(o,i){try{var n=e?e.version:void 0,d=LyteIDB.restoreData=e&&e.hasOwnProperty("restoreData")?e.restoreData:LyteIDB.restoreData,s=[],l=LyteIDB.idbNamePrefix+e.name;LyteIDB.initWorker(e?e.url:void 0).then(function(e){for(var c in store.model){var m=store.model[c];if(m.hasOwnProperty("idb")){var y={modelName:c,pK:store.model[c]._pK};m.idb.hasOwnProperty("maintainOrder")&&(y.maintainOrder=m.idb.maintainOrder),s.push(y)}}var u=store.$.cbScp("application","idbBeforeOpen","adapter");u&&(s=store.$.cB(u,[s])),setTimeout(function(){t?(e.postMessage({tolyteidb:!0,models:s,type:"open",version:n,maintainOrder:LyteIDB.maintainOrder,name:l}),s=[]):!1===d?(localStorage.setItem("idb"+r,1),LyteIDB.removeIDBDatabase().then(function(){e.postMessage({tolyteidb:!0,models:s,type:"open",version:n,maintainOrder:LyteIDB.maintainOrder,name:l}),s=[]})):(e.postMessage({tolyteidb:!0,models:s,type:"open",version:n,maintainOrder:LyteIDB.maintainOrder,name:l}),s=[]),localStorage.removeItem(window.location.host+"child"),localStorage.removeItem(window.location.host+"parent")},20),e.onmessage=function(e){var t=e.data;if(t&&t.lyteidb){if("open"==t.type){if("error"!=t.msg){void 0!=store.adapter.application&&store.adapter.application.differIDBAction||setTimeout(function(){LyteIDB.triggerIDBInsertion()},0),Object.defineProperty(LyteIDB,"isIDBOpened",{value:!0}),Object.defineProperty(store.$,"idbOpen",{value:!1}),LyteIDB.idb[l]=!0;var r=window.location.host,n=localStorage.getItem("idb"+r);return void 0==n?localStorage.setItem("idb"+r,1):(n=parseInt(n),localStorage.setItem("idb"+r,n+1)),!1===LyteIDB.restoreData&&window.addEventListener("beforeunload",function(){LyteIDB.removeCurrentIDB()}),o()}return i()}if("completed4"==t.qProcess){var d=Object.keys(store.$.idbQ2)[0];(t.data||[]).forEach(function(e,t){var r=store.$.peekRecord(d,e);Lyte.isRecord(r)&&a.changeIDBState(r)}),delete store.$.idbQ2[d],LyteIDB.isProcessing=!1}else if(t.hasOwnProperty("code")){var s=t.req,c=LyteIDB[t.model][t.req],m="findRecord"==s?c[t.key].splice(0,1)[0]:c.splice(0,1)[0];t.customData=m.customData,200==t.code?m&&m.resolve&&LyteIDB.normalizeIDBData(t).then(function(e){m.resolve(e)},function(){m.reject()}):400==t.code&&m&&m.reject&&(t.ScriptErr&&Lyte.error(t.ScriptErr.msg),m.reject()),0==c.length&&delete LyteIDB[t.model][t.req]}else if(t.pause){m=LyteIDB[t.model][t.req];var y=localStorage.getItem("pause");localStorage.setItem("pause",!y),m&&(m=Array.isArray(m)?m:[m]).forEach(function(e){e&&e.reject&&(t.ScriptErr&&Lyte.error(t.ScriptErr.msg),e.reject())})}}t.ScriptErr&&Lyte.error(t.ScriptErr.msg),0==Object.keys(store.$.idbQ2).length&&(LyteIDB.isProcessing=!1)}},function(){i()})}catch(e){Lyte.error(e)}})}catch(e){return Promise.reject()}},removeCurrentIDB:function(){return new Promise(function(e,t){var r=window.location.host,a=localStorage.getItem("idb"+r);if(void 0!=a&&parseInt(a)-1!=0)return localStorage.setItem("idb"+r,parseInt(a)-1),e();for(var o in LyteIDB.idb){var i=LyteIDB.removeIDBDatabase(o);console.log(i)}})},deleteIDB:function(e){return new Promise(function(t,r){var a=indexedDB.deleteDatabase(e);a.onsuccess=function(){return t()},a.onerror=function(){return r()}})},removeIDBDatabase:function(){return new Promise(function(e,t){indexedDB.databases().then(function(t){for(var r,a=t.length,o=0,i=0,n=0;n<a;n++)(r=t[n]).name.startsWith(LyteIDB.idbNamePrefix)&&(i++,LyteIDB.deleteIDB(r.name).then(function(){++o==i&&(localStorage.removeItem("idb"+window.location.host),LyteIDB.didInit=!1,e())},function(){++o==i&&(localStorage.removeItem("idb"+window.location.host),LyteIDB.didInit=!1,e())}));a&&i||e()})})},postMessage:function(e){try{if(LyteIDB.isIDBOpened){var t,r,a,o={model:e.model,key:e.key,type:e.req,customData:e.customData,queryParams:e.queryParams},i=store.$.initCB("adapter",o.model,"getIdbName",{args:[o.model]});if(i&&(t=LyteIDB.idbNamePrefix+i.data),(r=store.$.initCB("serializer",o.model,"beforeIDBGet",{args:[o]}))&&((a=r.data)&&"object"==typeof a?(delete a.type,Object.assign(e,a)):e&&e.reject&&e.reject()),e.resolve&&e.reject){LyteIDB[e.model]=LyteIDB[e.model]||{};var n={key:e.key,resolve:e.resolve,reject:e.reject,queryParams:e.queryParams,req:e.req,customData:e.customData};if("findRecord"==e.req){var d=LyteIDB[e.model][e.req]=LyteIDB[e.model][e.req]||{};(d[e.key]=d[e.key]||[]).push(n)}else{(LyteIDB[e.model][e.req]=LyteIDB[e.model][e.req]||[]).push(n)}delete e.resolve,delete e.reject}e.tolyteidb=!0,e.name=t,LyteIDB.worker.postMessage(e)}else e&&e.reject&&e.reject()}catch(t){Lyte.error(t),e&&e.reject&&e.reject()}},IDBInsert:function(){if(!LyteIDB.isProcessing&&Object.keys(store.$.idbQ2).length){for(var e=Object.keys(store.$.idbQ2)[0];e&&store.$.idbQ2[e]&&0==store.$.idbQ2[e].length;)delete store.$.idbQ2[e],e=Object.keys(store.$.idbQ2)[0];if(e){var t,r=store.$.idbQ2[e],a=store.modelFor(e)._pK,o=[],i=store.$.initCB("adapter",e,"getIdbName",{args:[e]});i&&(t=LyteIDB.idbNamePrefix+i.data),r.length?(r.forEach(function(e){var t,r;(t=store.$.initCB("serializer",e.model,"beforeIDBCrud",{args:[e]}))?(r=t.data)&&o.push(r):o.push(e)}),LyteIDB.serializedIDBdata(r,a).then(function(){o.length?(LyteIDB.isProcessing={q:r,module:e},console.log(Array.from(r)),LyteIDB.worker.postMessage({tolyteidb:!0,type:"push",module:e,data:r,pK:a,name:t})):delete store.$.idbQ2[e]})):delete store.$.idbQ2[e]}}0==Object.keys(store.$.idbQ2).length&&(LyteIDB.isProcessing=!1)},getPrimaryValues:function(e,t){return Array.isArray(t)||(t=[t]),newObj={},t.forEach(function(t){newObj[t]=e[t]}),newObj},normalizeIDBData:function(e){return new Promise(function(t,r){try{var a,o=e.data[e.model],i=e.data;if(!store.$.cbScp(e.model,"normalizeIDBRecord","serializer"))return t(i);if(Array.isArray(o))a=[],o.forEach(function(t){var r=LyteIDB.getPrimaryValues(t,store.model[e.model]._arrPk);r=1==Object.keys(r).length?t[Object.keys(r)[0]]:r;var o=store.$.initCB("serializer",e.model,"normalizeIDBRecord",{args:[e.model,r,t.__data__,e]});o&&(o.data,Promise,a.push(o.data))}),Lyte.resolvePromises(a).then(function(r){return i[e.model]=r,t(i)},function(){return Lyte.error("Error in getting model data from IndexedDB"),r()});else{var n=LyteIDB.getPrimaryValues(o,store.model[e.model]._arrPk);n=1==Object.keys(n).length?o[Object.keys(n)[0]]:n;var d=store.$.initCB("serializer",e.model,"normalizeIDBRecord",{args:[e.model,n,o.__data__,e]});if(d){if(d.data instanceof Promise)return d.data.then(function(r){return i[e.model]=r,t(i)},function(){return Lyte.error("Error in getting model data from IndexedDB"),r()});i[e.model]=d.data}}}catch(e){return Lyte.error(e),r()}})},serializedIDBdata:function(e,t){var r=[];return Array.isArray(e)&&e.length?(e.forEach(function(e){try{r.push(new Promise(function(r,a){if(!e.data)return r();var o;if(Array.isArray(e.data[e.model])){var i=[];if(e.data[e.model].forEach(function(t){(o=store.$.initCB("serializer",e.model,"serializeIDBRecord",{args:[e.model,t,e.data,e]}))&&(o.data,Promise,i.push(o.data))}),0==i.length)return r();Lyte.resolvePromises(i).then(function(a){return Array.isArray(a)&&a.forEach(function(r,a){var o=LyteIDB.getPrimaryValues(e.data[e.model][a],t.split(","));o.__data__=r,e.data.__data__||(e.data.__data__={},e.data.__data__[e.model]=[]),e.data.__data__[e.model].push(o)}),e.data=e.data.__data__?e.data.__data__:e.data,r()},function(){return Lyte.error("Error in updating model data in IndexedDB"),a()})}else{if(!(o=store.$.initCB("serializer",e.model,"serializeIDBRecord",{args:[e.model,e.data[e.model]?e.data[e.model]:e.data,e.data,e]})))return r();if(!(o.data instanceof Promise)){var n=o.data,d=LyteIDB.getPrimaryValues(e.data[e.model]?e.data[e.model]:e.data,t.split(","));return d.__data__=n,e.data.__data__=d,e.data[e.model]?(e.data[e.model]={},e.data.__data__&&(e.data[e.model]=e.data.__data__)):e.data.__data__&&(e.data=e.data.__data__),r()}Lyte.resolvePromises(o.data).then(function(a){var o=LyteIDB.getPrimaryValues(e.data[e.model]?e.data[e.model]:e.data,t.split(","));return o.__data__=a,e.data.__data__=o,e.data[e.model]?(e.data[e.model]={},e.data.__data__&&(e.data[e.model]=e.data.__data__)):e.data.__data__&&(e.data=e.data.__data__),r()},function(){return Lyte.error("Error in updating model data in IndexedDB"),a()})}}))}catch(e){return Lyte.error(e),reject()}}),Lyte.resolvePromises(r)):resolve()},triggerIDBInsertion:function(){setInterval(function(){setTimeout(LyteIDB.IDBInsert,0)},50)}};
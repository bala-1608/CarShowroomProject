Lyte.Component.register( 'lyte-comment', {

	didConnect : function(){
		this.$node.resetTime = this.reset_time.bind( this );

		this.detect_keywords();
	},

	detect_keywords : function(){
		var elem = this.$node.getElementsByClassName( 'lyteCommentText' )[ 0 ];
		if( elem ){
			var notecomp = this.$node.closest( 'lyte-notecomp' );
			if( notecomp ){
				notecomp.component.detect_keywords( elem );
			}
		}
	},

	init : function(){
		var str = '',
		data = this.data;

		if( data.ltPropVoiceNote ){
			str = "lyteNoteVoiceNoteComment";
		} else if( data.ltPropCheckIn ){
			str = "lyteNoteCheckinComment";
		}

		this.setData( 'commentType', str );

		if( data.ltPropEditorProps.emoji && data.ltPropEmoji && data.ltPropEmoji.length ){
			this.setData( 'firstReaction', data.ltPropEmoji[ 0 ] );
		}
	},

	obs : function(){
		if( this.data.ltPropPinnedComment ){
			return;
		}
		this.reset_time();
	}.observes( 'ltPropCreatedTime' ).on( 'init' ),

	preview_obs : function(){
		if( this.data.ltPropPinnedComment ){
			return;
		}
		this.preview_obs_check();
	}.observes( 'ltPropAttachments.[]' ).on( "init" ),

	emoji_obs : function(){
		var __data = this.data;

		if( __data.ltPropPinnedComment || !__data.ltPropEditorProps.emoji ){
			return;
		}
		var emoji = __data.ltPropEmoji;

		if( emoji && emoji.length ){
			this.setData( 'isReacted', emoji.length > 1 || emoji[ 0 ].count );
		}
	}.observes( 'ltPropEmoji.[]', 'firstReaction.count' ).on( 'init' ),

	more_options : function(){
		if( this.data.ltPropPinnedComment ){
			return;
		}
		var data = this.data;
		this.setData( 'moreOptions', data.isReacted || data.ltPropPin || data.ltPropDelete || data.ltPropEdit );
	}.observes( 'isReacted', 'ltPropPin', 'ltPropEdit', 'ltPropDelete' ).on( 'init' ),

	preview_obs_check : function(){
		var data = this.data.ltPropAttachments || [],
		obj = {
			image : "photo"
		},
		_utils = Lyte.objectUtils,
		frame_arr = [ "pdf", "video", "audio" ];

		data.forEach( function( item ){
			var _type = ( item.fileType || "image" ).toLowerCase(),
			_value = obj[ _type ];

			if( !_value ){
				if( frame_arr.indexOf( _type ) != -1 ){
					_value = "iframe/" + _type;
				} else{
					_value = "custom/" + _type;
				}
			}

			_utils( item, "add", "ctype", _value );
		}.bind( this ) );
	},

	edit_modeobs : function( arg ){
		if( this.data.ltPropPinnedComment ){
			return;
		}

		var is_edit = this.data.ltPropEditMode;

		if( is_edit ){
			var hgt = $L( '.lyteEditorContent', this.$node ).get( 0 ).offsetHeight;
			this.setData( 'height', hgt );

			this.setData( 'render', !0 );

			var cls_name = "lyteEditorHide",
			editor = $L( 'lyte-note-editor', this.$node ).eq( 0 );

			editor.removeClass( cls_name ).next().addClass( cls_name );

		} 

	}.observes( 'ltPropEditMode' ).on( 'didConnect' ),

	reset_time : function(){
		var data = this.data,
		time = data.ltPropCreatedTime,
		str,
		callback = 'onTimeConversion';

		if( !time ){
			return;
		}

		if( this.getMethods( callback ) ){
			var str = this.executeMethod( callback, time, 'comment' );

			this.setData( 'createdTime', str );
		}
	},

	convert_to_string : function( value ){
		var ret;
		try{
			var json = JSON.parse( value ),
			ret = _lyteUiEditor.jsonToString( json, this.data.ltPropTextEditor );
		}catch( e ){
			ret = value;
		}
		return ret;
	},

	convert_mention : function( arg ){
		this.setData( 'value', this.checkcount( this.convertback_mention( this.convert_to_string( this.data.ltPropValue ) ), this.data.ltPropPinnedComment ? Infinity : this.data.ltPropCount ) );

		arg && this.detect_keywords();

	}.observes( 'ltPropValue', 'ltPropCount' ).on( 'init' ),

	convertback_mention : function( text ){
		return text.replace(  /@\[(.+?):(.+?)\]/g, function( final, match1, match2 ){
			return '<span data-method = "onMentionClick" data-mouseover = "onMentionEnter" data-mouseout = "onMentionLeave" class = "lyteCommentUserMention" data-id = "' + match2 + '">' + match1 + '</span>'
		})

		// regex used in crm - shank

		.replace( /([\w](['A-Za-z0-9._%\-+]*@[A-Za-z0-9-]+(\.[a-zA-Z0-9-]{1,22}){0,9}\.[a-zA-Z]{2,22}))/g, '<a class = \'lyteNoteEmail\' href = \'mailto:$1\'>$1</a>' );

		// took this from https://stackoverflow.com/questions/3809401/what-is-a-good-regular-expression-to-match-a-url

		// .replace( /(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,})/g, '<a class = \'lyteNoteLink\' href = \'$1\' target = \'_blank\'>$1</a>' );
	},

	checkcount : function( text, count ){
		if( count == Infinity ){
			return text;
		}

		 var ret = _lyteUiEditor.limitFilter( text, count, true );

		 if( count == ret.length ){
		 	var text = ret.html,
		 	index = text.lastIndexOf( "</" + ( ret.tag || "p" ) + ">" );

		 	if( index == -1 ){
		 		index = ret.html.length;
		 	}
		 	
		 	return text.slice( 0, index ) + '...<span data-method = "more" class = "lyteCommentMoreString">' + this.data.ltPropText.more + '</span>' + text.slice( index );
		 }

		return ret.html;
	},

	data: function() {
		return {
			ltPropImage : Lyte.attr( 'string', { default : '' } ),

			ltPropHeader : Lyte.attr( 'array', { default : [] } ),

			ltPropEdit: Lyte.attr( 'boolean', { default : true } ),

			ltPropDelete : Lyte.attr( 'boolean', { default : true } ),

			ltPropEmoji : Lyte.attr( 'array', { default : [] } ),

			ltPropFooter : Lyte.attr( 'array', { default : [] } ),

			ltPropCreatedTime : Lyte.attr( 'string', { default : '' } ),

			ltPropValue : Lyte.attr( 'string', { default : "", hideAttr : true } ),

			ltPropEditMode : Lyte.attr( 'boolean', { default : false } ),

			ltPropReply : Lyte.attr( 'array', { default : [] } ),

			ltPropButtons : Lyte.attr( 'array', { default : [], hideAttr : true } ),

			ltPropCount : Lyte.attr( 'number', { default : 250 } ),

			ltPropTextEditor : Lyte.attr( 'object', { default : {} } ),

			ltPropEditorPanel : Lyte.attr( 'object', { default : {} } ),

			ltPropFileUpload : Lyte.attr( 'object', { default : {} } ),

			ltPropAttachments : Lyte.attr( 'array', { default : [] } ),

			ltPropStyle : Lyte.attr( 'object', { default : {} } ),

			ltPropEditorAnimation : Lyte.attr( 'string', { default : 'fade' } ),

			ltPropTooltipConfig : Lyte.attr( "string", { default : '{}' } ),

			ltPropText : Lyte.attr( "object", { default : {
					fileUpload : _lyteUiUtils.i18n( "upload.file", "note", "File upload" ),
					storage : _lyteUiUtils.i18n( "storage", "note", "Storage" ),
					more : _lyteUiUtils.i18n( "more", "note", "More" )
			} } ),

			ltPropVoiceNote : Lyte.attr( 'object' ),

			ltPropCheckIn : Lyte.attr( "object" ),

			ltPropPin : Lyte.attr( 'boolean', { default : false } ),

			ltPropPinnedComment : Lyte.attr( 'boolean', { default : false } ),

			ltPropReplyYield : Lyte.attr( 'boolean', { default : false } ),

			ltPropEditorProps : Lyte.attr( 'object', { default : {
			        background : true,
			        attachment : true,
			        emoji : true,
			        editorpanel : true
			    } 
			}),

			ltPropImageText : Lyte.attr( 'string', { default : "" } ),

			ltPropTabindex : Lyte.attr( 'number', { default : 0 } ),

			// systemData
			
			createdTime : Lyte.attr( 'object', { default : {} } ),

			sanitizer : Lyte.attr( 'object', {}),

			value : Lyte.attr( 'string', { default : '', hideAttr : true } ),

			height : Lyte.attr( 'number', { default : 0 } ),

			commentType : Lyte.attr( 'string' ),

			isReacted : Lyte.attr( 'boolean' ),

			moreOptions : Lyte.attr( 'boolean' ),

			firstReaction : Lyte.attr( 'object' ),

			id : Lyte.attr( 'string', { default : "" } ),
			dataIndex : Lyte.attr( 'string', { default : "" } )
		}
	},

	actions : {
		comment_click : function( evt, name ){
			var method_name = this.get_method_name( evt.target, name || 'data-method' );
			if( method_name ){
				switch( method_name.method ){
					case 'more' : {
						return this.more();
					}
					break;
					default : {
						this.throwEvent( 'common_action', method_name.method, evt, method_name.target, this.$node );
					}
				}
			}
		},

		cancel : function( editor ){
			this.throwEvent( 'cancel_comment', editor, this.$node );
			return false;
		},

		save : function( editor ){
			this.throwEvent( 'update_comment', editor, this.$node );
			return false;
		},

		mouseenter : function( _this, index ){
			if( index == 0 ){
				this._timeout = setTimeout( function(){
					this.throwEvent( 'show_emoji', _this );
				}.bind( this ), 100);
			}
		},

		mouseleave : function(){
			this.didDestroy();
		},

		download : function( evt, _this ){

			if( this.getMethods('onBeforeCommentDownload') ){
				let data = this.data

				let id = evt.target.parentElement && evt.target.parentElement.id;

				let ret = this.executeMethod( 'onBeforeCommentDownload', data.id, data.ltPropAttachments, id, evt, this.$node );
				
				if( ret === false ){ 
					event.preventDefault();
					return ret; 
				}
			}

			evt.stopPropagation();
			evt.stopImmediatePropagation();
			return false;
		},

		error : function(){
			if( this.data.ltPropImageText ){
				this.setData('ltPropImage' , '');
			}
		},

		option_focus : function( elem ){
			$L( elem ).css( 'opacity', 1 );
		},

		option_blur : function( elem ){
			$L( elem ).css( 'opacity', 0 );
		},

		comment_mouseenter : function(){
			$L( this.$node ).find( '.lyteNoteCommentMoreOptions' ).css( 'opacity', 1 );
		},

		comment_mouseleave : function(){
			$L( this.$node ).find( '.lyteNoteCommentMoreOptions' ).css( 'opacity', 0 );
		},

		comment_keydown : function(evt){
			if( evt.keyCode == 32 || evt.keyCode == 13 ){
				var method_name = this.get_method_name( evt.target, 'data-method' );
				if( method_name ){
					switch( method_name.method ){
						case 'more' : {
							return this.more();
						}
						break;
						default : {
							this.throwEvent( 'common_action', method_name.method, evt, method_name.target, this.$node );
						}
					}
				}
			}
		},

		hideHoverCard : function(evt){
			this.throwEvent( 'hideHoverCard', evt );
		},

		option_keydown : function( _this, evt ){
			if( evt.keyCode == 32 || evt.keyCode == 13 ){
				_this.click();
			}
		}
	},

	more : function(){
		this.setData( 'ltPropCount', Infinity );
	},

	didDestroy : function(){
		clearTimeout( this._timeout );
		delete this._timeout;
	},

	methods : {
		onTimeConversion : function(){
		},
		onTrigger : function( value, position, editor ){
			if( this.getMethods( 'onTrigger' ) ){
				return this.executeMethod( 'onTrigger', value, position, editor );
			}
		},

		modeswitch : function( value, _editor ){
			if( !value ){
				var cls = 'lyteEditorHide';
				$L( _editor ).addClass( cls ).next().removeClass( cls );
			}
		},

		beforeDownload : function(){
			if( this.getMethods( 'onBeforeCommentDownload' ) ){
				return this.executeMethod( 'onBeforeCommentDownload', arguments[0], arguments[1], arguments[2] );
			}
		}
	},

	get_method_name : function( target, name ){

		var fn  = function( elem, query ){
			if( elem.closest ){
				return elem.closest( query );
			}
			return $L( elem ).closest( query ).get( 0 );
		},
		comment = fn( target, 'lyte-comment' );

		if( comment == this.$node ){
			var element = fn( target, '[' + name + ']:not([' + name + '=""])' );

			if( element ){
				return{
					method : $L( element ).attr( name ),
					target : element
				}
			}
		}
	}
});


Lyte.Component.registerHelper( 'lyteNoteStyle', function( background, border ){

	if( !background ){
		return "";
	}

	var obj;
	
	if( border && background ){
		obj = {
			background : background,
			border : border
		}
	} else{
		if( background.constructor == String ){
			return "background:" + background;
		}
		obj = {
			background : background.background,
			border : background.border
		}
	}

	return _lyteUiEditor.inlineStyle( obj );
});

Lyte.Component.registerHelper( 'lyteUiCommentEmoji', function( className, selected, count ){
	var str = className || '';

	if( selected ){
		str += ' lyteEmojiSelected';
	}

	if( count != void 0 ){
		str += ( ' lyte_emoji_reactions_' + count );
	}

	return str.trim();
});
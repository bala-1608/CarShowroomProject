Lyte.Component.register("lyte-nested-table", {
	data : function(){
		return {
			ltPropHeader : Lyte.attr( 'array', { default : [] } ),
			ltPropContent : Lyte.attr( 'array', { default : [] } ),
			ltPropGroupTitle : Lyte.attr( 'string', { default : "" } ),
			isGroup : Lyte.attr( 'boolean', { default : true } ),

			renderContent : Lyte.attr( 'array', { default : [] } ),
			topLevel : Lyte.attr( 'boolean', { default : false } ),
			intersection : Lyte.attr( "object" )
		}		
	},

	didConnect : function(){
		if( this.data.topLevel ){
			var scroll_elem = this.$node.querySelector( '.lyteListviewTableHolder' );
			this.setData( 'intersection', { obs : new IntersectionObserver( this.intersection.bind( this ), { threshold : [ 0.01 ], root : document } ) } );
		} else if( this.data.intersection ){
			this.add_to_inter();
		}
	},

	didDestroy : function(){
		var obs = this.data.intersection,
		span = $L( this.$node.children ).get( -1 );
		obs.obs.unobserve( span );

		this.data.intersection = void 0;
	},

	intersection : function( intersections ){
		intersections.forEach( function( item ){
			if( item.intersectionRatio ){
				var target = item.target,
				table = target.parentNode,
				root_bound = item.rootBounds,
				__this = table.component;

				if( !__this.add_more_data() ){
					__this.check_nested_end( root_bound, target );
				}
			}
		} ); 
	},

	check_nested_end : function( root_bound, target ){
		var __this = this;
		$L.fastdom.measure( function(){
			var bcr = target.getBoundingClientRect(),
			is_vert_outside = root_bound.top > bcr.bottom || root_bound.bottom < bcr.top,
			is_hori_outside = root_bound.left > bcr.right || root_bound.right < bcr.left;

			if( !( is_vert_outside || is_hori_outside ) ){
				$L.fastdom.mutate( function(){
					if( !__this.add_more_data() ){
						__this.check_nested_end( root_bound, target );
					}
				} )
			}
		} )
	},

	obs : function(){
		this.add_to_inter();
	}.observes( 'intersection' ),

	content_obs : function( arg ){
		this.setData( 'renderContent', [] );
		this.add_more_data();
	}.observes( 'ltPropContent' ),

	add_to_inter : function(){ 
		var  obs = this.data.intersection,
		span = $L( this.$node.children ).get( -1 );
		obs.obs.observe( span );
	},

	init : function(){
		// var td = this.$node.closest( '.lyteGroupHeadingData  ' )
		// this.add_more_data();
	},

	add_more_data : function(){
		var __data = this.data,
		renderContent = __data.renderContent,
		content = __data.ltPropContent || [],
		__len = renderContent.length;

		if( __len == content.length ){
			return true;
		}

		Lyte.arrayUtils( renderContent, 'push', content.slice( __len, __len + 10 ) );
	}
});